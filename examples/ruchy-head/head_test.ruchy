// ruchy-head: Output the first n lines of a file
// Sprint 4 - Chapter 4 example from Ruchy CLI Tools Book
// EXTREME TDD: Tests and implementation together

// Returns the first n lines from a file.
// If n is greater than the number of lines, returns all lines.
// If n is 0, returns empty string.
fun head_lines(file_path, n) {
    let content = fs_read(file_path)
    let result = ""
    let line_count = 0

    for i in range(0, content.len()) {
        let ch = content[i]

        if line_count < n {
            result = result + ch
        }

        if ch == "\n" {
            line_count = line_count + 1
            if line_count >= n {
                return result
            }
        }
    }

    result
}

// ============================================================================
// UNIT TESTS
// ============================================================================

@test("returns first n lines from file")
fun test_head_basic() {
    let test_file = "test_head_basic.txt"
    let test_content = "Line 1\nLine 2\nLine 3\nLine 4\nLine 5\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 3)

    assert_eq(result, "Line 1\nLine 2\nLine 3\n", "Should return first 3 lines")

    fs_remove_file(test_file)
}

@test("returns single line when n=1")
fun test_head_single() {
    let test_file = "test_head_single.txt"
    let test_content = "First line\nSecond line\nThird line\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 1)

    assert_eq(result, "First line\n", "Should return only first line")

    fs_remove_file(test_file)
}

@test("returns empty string when n=0")
fun test_head_zero() {
    let test_file = "test_head_zero.txt"
    let test_content = "Line 1\nLine 2\nLine 3\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 0)

    assert_eq(result, "", "Should return empty string when n=0")

    fs_remove_file(test_file)
}

@test("returns all lines when n exceeds file length")
fun test_head_exceeds() {
    let test_file = "test_head_exceeds.txt"
    let test_content = "Line 1\nLine 2\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 100)

    assert_eq(result, "Line 1\nLine 2\n", "Should return all lines")

    fs_remove_file(test_file)
}

@test("handles file without trailing newline")
fun test_head_no_trailing_newline() {
    let test_file = "test_head_no_trailing.txt"
    let test_content = "Line 1\nLine 2\nLine 3"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 2)

    assert_eq(result, "Line 1\nLine 2\n", "Should return first 2 complete lines")

    fs_remove_file(test_file)
}

@test("handles empty file")
fun test_head_empty() {
    let test_file = "test_head_empty.txt"
    let test_content = ""
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 5)

    assert_eq(result, "", "Should return empty string for empty file")

    fs_remove_file(test_file)
}

@test("handles single line file")
fun test_head_single_line_file() {
    let test_file = "test_head_single_line.txt"
    let test_content = "Only one line\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 5)

    assert_eq(result, "Only one line\n", "Should return the single line")

    fs_remove_file(test_file)
}

@test("handles large n value")
fun test_head_large_n() {
    let test_file = "test_head_large_n.txt"
    let test_content = "Line 1\nLine 2\nLine 3\n"
    fs_write(test_file, test_content)

    let result = head_lines(test_file, 1000)

    assert_eq(result, "Line 1\nLine 2\nLine 3\n", "Should return all lines for very large n")

    fs_remove_file(test_file)
}

// ============================================================================
// PROPERTY-BASED TESTS
// ============================================================================

@test("property: head is idempotent")
fun property_idempotent() {
    let test_file = "test_property_idempotent.txt"
    let test_content = "Line 1\nLine 2\nLine 3\nLine 4\nLine 5\n"
    fs_write(test_file, test_content)

    let first_result = head_lines(test_file, 3)

    // Property: Running head multiple times on same file gives same result
    for i in range(0, 50) {
        let result = head_lines(test_file, 3)
        assert_eq(result, first_result, "head should be idempotent")
    }

    fs_remove_file(test_file)
}

@test("property: head output never exceeds input")
fun property_output_size() {
    let test_file = "test_property_size.txt"

    // Test with various file sizes
    for size in range(1, 20) {
        let test_content = ""
        for i in range(0, size) {
            test_content = test_content + "Line " + i.to_string() + "\n"
        }

        fs_write(test_file, test_content)

        let original_size = test_content.len()

        // Test with various n values
        for n in range(0, size + 5) {
            let result = head_lines(test_file, n)
            let result_size = result.len()

            // Property: Output size never exceeds input size
            assert_eq(result_size <= original_size, true, "head output should not exceed input size")
        }
    }

    fs_remove_file(test_file)
}

@test("property: head(n) line count never exceeds n")
fun property_line_count_limit() {
    let test_file = "test_property_lines.txt"

    // Create a file with known number of lines
    let test_content = ""
    for i in range(0, 20) {
        test_content = test_content + "Line " + i.to_string() + "\n"
    }
    fs_write(test_file, test_content)

    // Test various n values
    for n in range(0, 25) {
        let result = head_lines(test_file, n)

        // Count lines in result
        let line_count = 0
        for i in range(0, result.len()) {
            if result[i] == "\n" {
                line_count = line_count + 1
            }
        }

        // Property: Result line count never exceeds n
        assert_eq(line_count <= n, true, "head should return at most n lines")
    }

    fs_remove_file(test_file)
}

@test("property: head(0) always returns empty")
fun property_zero_lines() {
    let test_file = "test_property_zero.txt"

    // Test with various file contents
    for size in range(0, 30) {
        let test_content = ""
        for i in range(0, size) {
            test_content = test_content + "Content " + i.to_string() + "\n"
        }

        fs_write(test_file, test_content)

        let result = head_lines(test_file, 0)

        // Property: head(0) always returns empty string
        assert_eq(result, "", "head(0) should always return empty string")
    }

    fs_remove_file(test_file)
}
